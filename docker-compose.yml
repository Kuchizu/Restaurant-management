services:
  # ============================================
  # Kafka Cluster (3 brokers with KRaft mode)
  # ============================================
  kafka-1:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka-1
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://kafka-1:9092,CONTROLLER://kafka-1:9093,EXTERNAL://0.0.0.0:29092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-1:9092,EXTERNAL://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka-1:9093,2@kafka-2:9093,3@kafka-3:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 2
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 2
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_DEFAULT_REPLICATION_FACTOR: 2
      KAFKA_MIN_INSYNC_REPLICAS: 2
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_LOG_DIRS: /var/lib/kafka/data
      CLUSTER_ID: G8YSUisMQfun5VVQtDT-fw
    ports:
      - "29092:29092"
    volumes:
      - kafka1_data:/var/lib/kafka/data
    networks:
      - restaurant-network
    healthcheck:
      test: ["CMD-SHELL", "test -f /var/lib/kafka/data/meta.properties"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  kafka-2:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka-2
    environment:
      KAFKA_NODE_ID: 2
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://kafka-2:9092,CONTROLLER://kafka-2:9093,EXTERNAL://0.0.0.0:29093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-2:9092,EXTERNAL://localhost:29093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka-1:9093,2@kafka-2:9093,3@kafka-3:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 2
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 2
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_DEFAULT_REPLICATION_FACTOR: 2
      KAFKA_MIN_INSYNC_REPLICAS: 2
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_LOG_DIRS: /var/lib/kafka/data
      CLUSTER_ID: G8YSUisMQfun5VVQtDT-fw
    ports:
      - "29093:29093"
    volumes:
      - kafka2_data:/var/lib/kafka/data
    networks:
      - restaurant-network
    healthcheck:
      test: ["CMD-SHELL", "test -f /var/lib/kafka/data/meta.properties"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  kafka-3:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka-3
    environment:
      KAFKA_NODE_ID: 3
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://kafka-3:9092,CONTROLLER://kafka-3:9093,EXTERNAL://0.0.0.0:29094
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-3:9092,EXTERNAL://localhost:29094
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka-1:9093,2@kafka-2:9093,3@kafka-3:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 2
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 2
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_DEFAULT_REPLICATION_FACTOR: 2
      KAFKA_MIN_INSYNC_REPLICAS: 2
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_LOG_DIRS: /var/lib/kafka/data
      CLUSTER_ID: G8YSUisMQfun5VVQtDT-fw
    ports:
      - "29094:29094"
    volumes:
      - kafka3_data:/var/lib/kafka/data
    networks:
      - restaurant-network
    healthcheck:
      test: ["CMD-SHELL", "test -f /var/lib/kafka/data/meta.properties"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # Kafka UI for monitoring
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    environment:
      KAFKA_CLUSTERS_0_NAME: restaurant-cluster
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka-1:9092,kafka-2:9092,kafka-3:9092
    ports:
      - "8090:8080"
    networks:
      - restaurant-network
    depends_on:
      kafka-1:
        condition: service_healthy
      kafka-2:
        condition: service_healthy
      kafka-3:
        condition: service_healthy

  # Kafka topics initialization
  kafka-init:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka-init
    depends_on:
      kafka-1:
        condition: service_healthy
      kafka-2:
        condition: service_healthy
      kafka-3:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-c"]
    command: |
      "
      echo 'Waiting for Kafka to be ready...'
      sleep 10

      kafka-topics --bootstrap-server kafka-1:9092 --create --if-not-exists --topic restaurant.orders.created --partitions 3 --replication-factor 2
      kafka-topics --bootstrap-server kafka-1:9092 --create --if-not-exists --topic restaurant.orders.sent-to-kitchen --partitions 3 --replication-factor 2
      kafka-topics --bootstrap-server kafka-1:9092 --create --if-not-exists --topic restaurant.kitchen.dish-ready --partitions 3 --replication-factor 2
      kafka-topics --bootstrap-server kafka-1:9092 --create --if-not-exists --topic restaurant.billing.generated --partitions 3 --replication-factor 2
      kafka-topics --bootstrap-server kafka-1:9092 --create --if-not-exists --topic restaurant.billing.paid --partitions 3 --replication-factor 2
      kafka-topics --bootstrap-server kafka-1:9092 --create --if-not-exists --topic restaurant.files.uploaded --partitions 3 --replication-factor 2
      kafka-topics --bootstrap-server kafka-1:9092 --create --if-not-exists --topic restaurant.inventory.low-stock --partitions 3 --replication-factor 2

      echo 'Topics created:'
      kafka-topics --bootstrap-server kafka-1:9092 --list
      "
    networks:
      - restaurant-network

  # ============================================
  # MinIO (S3-compatible storage)
  # ============================================
  minio:
    image: minio/minio:latest
    container_name: minio
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin123
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    networks:
      - restaurant-network
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # MinIO bucket initialization
  minio-init:
    image: minio/mc:latest
    container_name: minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-c"]
    command: |
      "
      mc alias set myminio http://minio:9000 minioadmin minioadmin123
      mc mb myminio/dish-images --ignore-existing
      mc anonymous set download myminio/dish-images
      echo 'MinIO bucket created: dish-images'
      "
    networks:
      - restaurant-network

  # ============================================
  # PostgreSQL databases
  # ============================================
  order-db:
    image: postgres:15-alpine
    container_name: order-db
    environment:
      POSTGRES_DB: order_db
      POSTGRES_USER: restaurant_user
      POSTGRES_PASSWORD: restaurant_pass
    ports:
      - "5432:5432"
    volumes:
      - order_data:/var/lib/postgresql/data
    networks:
      - restaurant-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U restaurant_user -d order_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  kitchen-db:
    image: postgres:15-alpine
    container_name: kitchen-db
    environment:
      POSTGRES_DB: kitchen_db
      POSTGRES_USER: restaurant_user
      POSTGRES_PASSWORD: restaurant_pass
    ports:
      - "5433:5432"
    volumes:
      - kitchen_data:/var/lib/postgresql/data
    networks:
      - restaurant-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U restaurant_user -d kitchen_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  menu-db:
    image: postgres:15-alpine
    container_name: menu-db
    environment:
      POSTGRES_DB: menu_db
      POSTGRES_USER: restaurant_user
      POSTGRES_PASSWORD: restaurant_pass
    ports:
      - "5434:5432"
    volumes:
      - menu_data:/var/lib/postgresql/data
    networks:
      - restaurant-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U restaurant_user -d menu_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  inventory-db:
    image: postgres:15-alpine
    container_name: inventory-db
    environment:
      POSTGRES_DB: inventory_db
      POSTGRES_USER: restaurant_user
      POSTGRES_PASSWORD: restaurant_pass
    ports:
      - "5435:5432"
    volumes:
      - inventory_data:/var/lib/postgresql/data
    networks:
      - restaurant-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U restaurant_user -d inventory_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  billing-db:
    image: postgres:15-alpine
    container_name: billing-db
    environment:
      POSTGRES_DB: billing_db
      POSTGRES_USER: restaurant_user
      POSTGRES_PASSWORD: restaurant_pass
    ports:
      - "5436:5432"
    volumes:
      - billing_data:/var/lib/postgresql/data
    networks:
      - restaurant-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U restaurant_user -d billing_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  auth-db:
    image: postgres:15-alpine
    container_name: auth-db
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: restaurant_user
      POSTGRES_PASSWORD: restaurant_pass
    ports:
      - "5437:5432"
    volumes:
      - auth_data:/var/lib/postgresql/data
    networks:
      - restaurant-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U restaurant_user -d auth_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  file-db:
    image: postgres:15-alpine
    container_name: file-db
    environment:
      POSTGRES_DB: file_db
      POSTGRES_USER: restaurant_user
      POSTGRES_PASSWORD: restaurant_pass
    ports:
      - "5438:5432"
    volumes:
      - file_data:/var/lib/postgresql/data
    networks:
      - restaurant-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U restaurant_user -d file_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Infrastructure services
  eureka-server:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_NAME: eureka-server
    container_name: eureka-server
    environment:
      SERVER_PORT: 8761
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
    ports:
      - "8761:8761"
    networks:
      - restaurant-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8761/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  config-server:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_NAME: config-server
    container_name: config-server
    environment:
      SERVER_PORT: 8888
      SPRING_PROFILES_ACTIVE: git
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
    ports:
      - "8888:8888"
    networks:
      - restaurant-network
    depends_on:
      eureka-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8888/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Microservices
  order-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_NAME: order-service
    container_name: order-service
    environment:
      SPRING_PROFILES_ACTIVE: prod
      MANAGEMENT_SERVER_PORT: 8080
      DATABASE_URL: r2dbc:postgresql://order-db:5432/order_db
      DATABASE_USERNAME: restaurant_user
      DATABASE_PASSWORD: restaurant_pass
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
      CONFIG_SERVER_URL: http://config-server:8888
      SQL_INIT_MODE: always
      KAFKA_BOOTSTRAP_SERVERS: kafka-1:9092,kafka-2:9092,kafka-3:9092
    networks:
      - restaurant-network
    depends_on:
      order-db:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
      kafka-1:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  kitchen-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_NAME: kitchen-service
    container_name: kitchen-service
    environment:
      SPRING_PROFILES_ACTIVE: prod
      MANAGEMENT_SERVER_PORT: 8080
      DATABASE_URL: jdbc:postgresql://kitchen-db:5432/kitchen_db
      DATABASE_USERNAME: restaurant_user
      DATABASE_PASSWORD: restaurant_pass
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
      CONFIG_SERVER_URL: http://config-server:8888
      JPA_DDL_AUTO: none
      JPA_SHOW_SQL: false
      LIQUIBASE_ENABLED: true
      KAFKA_BOOTSTRAP_SERVERS: kafka-1:9092,kafka-2:9092,kafka-3:9092
    networks:
      - restaurant-network
    depends_on:
      kitchen-db:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
      kafka-1:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  menu-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_NAME: menu-service
    container_name: menu-service
    environment:
      SPRING_PROFILES_ACTIVE: prod
      MANAGEMENT_SERVER_PORT: 8080
      DATABASE_URL: jdbc:postgresql://menu-db:5432/menu_db
      DATABASE_USERNAME: restaurant_user
      DATABASE_PASSWORD: restaurant_pass
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
      CONFIG_SERVER_URL: http://config-server:8888
      JPA_DDL_AUTO: none
      JPA_SHOW_SQL: false
      LIQUIBASE_ENABLED: true
      KAFKA_BOOTSTRAP_SERVERS: kafka-1:9092,kafka-2:9092,kafka-3:9092
    networks:
      - restaurant-network
    depends_on:
      menu-db:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
      kafka-1:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  inventory-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_NAME: inventory-service
    container_name: inventory-service
    environment:
      SPRING_PROFILES_ACTIVE: prod
      MANAGEMENT_SERVER_PORT: 8080
      DATABASE_URL: jdbc:postgresql://inventory-db:5432/inventory_db
      DATABASE_USERNAME: restaurant_user
      DATABASE_PASSWORD: restaurant_pass
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
      CONFIG_SERVER_URL: http://config-server:8888
      JPA_DDL_AUTO: none
      JPA_SHOW_SQL: false
      LIQUIBASE_ENABLED: true
      KAFKA_BOOTSTRAP_SERVERS: kafka-1:9092,kafka-2:9092,kafka-3:9092
    networks:
      - restaurant-network
    depends_on:
      inventory-db:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
      kafka-1:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  billing-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_NAME: billing-service
    container_name: billing-service
    environment:
      SPRING_PROFILES_ACTIVE: prod
      MANAGEMENT_SERVER_PORT: 8080
      DATABASE_URL: jdbc:postgresql://billing-db:5432/billing_db
      DATABASE_USERNAME: restaurant_user
      DATABASE_PASSWORD: restaurant_pass
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
      CONFIG_SERVER_URL: http://config-server:8888
      JPA_DDL_AUTO: none
      JPA_SHOW_SQL: false
      LIQUIBASE_ENABLED: true
      KAFKA_BOOTSTRAP_SERVERS: kafka-1:9092,kafka-2:9092,kafka-3:9092
    networks:
      - restaurant-network
    depends_on:
      billing-db:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
      kafka-1:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  file-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_NAME: file-service
    container_name: file-service
    environment:
      SPRING_PROFILES_ACTIVE: prod
      MANAGEMENT_SERVER_PORT: 8080
      DATABASE_URL: jdbc:postgresql://file-db:5432/file_db
      DATABASE_USERNAME: restaurant_user
      DATABASE_PASSWORD: restaurant_pass
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
      CONFIG_SERVER_URL: http://config-server:8888
      JPA_DDL_AUTO: none
      JPA_SHOW_SQL: false
      LIQUIBASE_ENABLED: true
      KAFKA_BOOTSTRAP_SERVERS: kafka-1:9092,kafka-2:9092,kafka-3:9092
      MINIO_ENDPOINT: http://minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin123
      MINIO_BUCKET: dish-images
    networks:
      - restaurant-network
    depends_on:
      file-db:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
      kafka-1:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  api-gateway:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_NAME: api-gateway
    container_name: api-gateway
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SERVER_PORT: 49999
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
      CONFIG_SERVER_URL: http://config-server:8888
      AUTH_DATABASE_URL: r2dbc:postgresql://auth-db:5432/auth_db
      DATABASE_USERNAME: restaurant_user
      DATABASE_PASSWORD: restaurant_pass
      JWT_SECRET: dGhpcyBpcyBhIHZlcnkgc2VjdXJlIGp3dCBzZWNyZXQga2V5IGZvciByZXN0YXVyYW50IG1hbmFnZW1lbnQ=
    ports:
      - "49999:49999"
    networks:
      - restaurant-network
    depends_on:
      eureka-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
      auth-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:49999/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

networks:
  restaurant-network:
    driver: bridge

volumes:
  order_data:
  kitchen_data:
  menu_data:
  inventory_data:
  billing_data:
  auth_data:
  file_data:
  kafka1_data:
  kafka2_data:
  kafka3_data:
  minio_data:
